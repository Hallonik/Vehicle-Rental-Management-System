<mat-card class="page">
    <div class="header">
        <h2>Users</h2>
        <span class="spacer"></span>
        <button mat-stroked-button (click)="exportCsv()">
            <mat-icon>download</mat-icon>&nbsp;Export CSV
        </button>
        <!-- <button color="primary" mat-raised-button (click)="openAdd()">
            <mat-icon>person_add</mat-icon>&nbsp;Add User
        </button> -->
    </div>

    <form [formGroup]="filterForm" class="filters" autocomplete="off">
        <mat-form-field appearance="outline">
            <mat-label>Search</mat-label>
            <input matInput formControlName="query" placeholder="name, email, phone..">
            <button *ngIf="filterForm.value.query" matSuffix mat-icon-button
                (click)="filterForm.patchValue({query:''})">
                <mat-icon>close</mat-icon>
            </button>
        </mat-form-field>

        <!-- <mat-form-field appearance="outline">
            <mat-label>Role</mat-label>
            <mat-select formControlName="role">
                <mat-option value="">All</mat-option>
                <mat-option *ngFor="let r of roles" [value]="r">{{ r }}</mat-option>
            </mat-select>
        </mat-form-field> -->

        <mat-form-field appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
                <mat-option value="">All</mat-option>
                <mat-option value="ACTIVE">Active</mat-option>
                <mat-option value="BLOCKED">Blocked</mat-option>
            </mat-select>
        </mat-form-field>

        <span class="spacer"></span>
        <!-- <button mat-raised-button color="primary" type="button">Apply</button> -->
        <button mat-raised-button color="primary" type="button" (click)="resetFilters()">Reset</button>
    </form>

    <div class="table-wrap" *ngIf="!loading; else loadingTpl">
        <table mat-table [dataSource]="dataSource" matSort>

            <ng-container matColumnDef="userId">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
                <td mat-cell *matCellDef="let r">{{ r.userId }}</td>
            </ng-container>

            <ng-container matColumnDef="fullName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
                <td mat-cell *matCellDef="let r">{{ r.fullName }}</td>
            </ng-container>

            <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
                <td mat-cell *matCellDef="let r">{{ r.email }}</td>
            </ng-container>
            <ng-container matColumnDef="userName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>UserName</th>
                <td mat-cell *matCellDef="let r">{{ r.userName }}</td>
            </ng-container>

            <ng-container matColumnDef="phone">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Phone</th>
                <td mat-cell *matCellDef="let r">{{ r.phone || '—' }}</td>
            </ng-container>

            <ng-container matColumnDef="drivingLicenseNumber">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>DrivingLicense</th>
                <td mat-cell *matCellDef="let r">{{ r.drivingLicenseNumber|| '—' }}</td>
            </ng-container>



            <ng-container matColumnDef="role">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Role</th>
                <td mat-cell *matCellDef="let r">
                    <mat-chip-set>
                        <mat-chip color="primary" variant="outlined">{{ r.role }}</mat-chip>
                    </mat-chip-set>
                </td>
            </ng-container>

            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let r">
                    <mat-chip-listbox>
                        <mat-chip-option [selected]="true" [color]="r.status === 'ACTIVE' ? 'primary' : 'warn'"
                            variant="outlined">
                            {{ r.status === 'ACTIVE' ? 'Active' : 'Blocked' }}
                        </mat-chip-option>
                    </mat-chip-listbox>
                </td>
            </ng-container>

            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let r" class="actions">
                    <!-- <button mat-icon-button matTooltip="Edit" (click)="openEdit(r)">
                        <mat-icon>edit</mat-icon>
                    </button> -->
                    <button mat-icon-button matTooltip="{{  r.status === 'ACTIVE' ? 'Block' : 'Unblock' }}" (click)="toggleStatus(r)">
                        <mat-icon>{{ r.status === 'ACTIVE' ? 'block' : 'undo' }}</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" matTooltip="Delete" (click)="delete(r)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            <tr class="empty" *ngIf="dataSource.data.length === 0">
                <td [attr.colspan]="displayedColumns.length">
                    No users found.
                </td>
            </tr>
        </table>

        <mat-paginator [pageSize]="10" [pageSizeOptions]="[5,10,25,50]"></mat-paginator>
    </div>

    <ng-template #loadingTpl>
        <div class="loading">
            <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        </div>
    </ng-template>
</mat-card>